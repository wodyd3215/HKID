<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="boardMapper">
  
  <resultMap id="boardResultSet" type="Board">
  	<result column="BOARD_NO" property="boardNo"/>
  	<result column="BOARD_TITLE" property="boardTitle"/>
  	<result column="BOARD_DATE" property="boardDate"/>
  	<result column="BOARD_CONTENT" property="content"/>
  	<result column="BOARD_VIEW_COUNT" property="boardViewCount"/>
  	<result column="BOARD_STATUS" property="boardStatus"/>
  	<result column="COMMUNITY_NO" property="communityNo"/>
  	<result column="MEMBER_NO" property="memberNo"/>
  	<result column="NICKNAME" property="nickName"/>
  </resultMap>
  
  <resultMap id="commmunityResultSet" type="Community">
  	<result column="BOARD_NO" property="boardNo"/>
  	<result column="BOARD_TITLE" property="boardTitle"/>
  	<result column="BOARD_DATE" property="boardDate"/>
  	<result column="BOARD_VIEW_COUNT" property="boardViewCount"/>
  	<result column="COMMUNITY_NAME" property="communityName"/>
  	<result column="NICKNAME" property="userName"/>
  </resultMap>
  
  <!-- 게시글 총 갯수 조회 -->
  <select id="selectListCount" resultType="_int">
  	SELECT COUNT(*) 
  	  FROM COMMUNITY
  	 WHERE BOARD_STATUS = 'Y' AND
  	 	   COMMUNITY_NO != 1 <!-- 공지 제외 -->
  	 
  </select>
  
  <!-- 카테고리 게시글의 개수 조회 -->
  <select id="selectCategoryListCount" resultType="_int">
  	 SELECT COUNT(*) 
  	   FROM COMMUNITY
  	   JOIN COMMUNITY_CATEGORY USING(COMMUNITY_NO)
	  WHERE BOARD_STATUS = 'Y' AND <!-- 게시글 상태가 'Y'이고 커뮤니티 이름이 동일한  -->
	  		COMMUNITY_NAME = #{category}
  </select>
  
  <!-- 게시글 조회 -->
  <select id="selectList" resultType="Community">
  	 SELECT BOARD_NO boardNo,
			BOARD_TITLE boardTitle,
			TO_CHAR(BOARD_DATE, 'YYYY-MM-DD') boardDate ,
			BOARD_VIEW_COUNT boardViewCount ,
			COMMUNITY_NAME communityName,
			NICKNAME userName
	   FROM COMMUNITY
       JOIN COMMUNITY_CATEGORY USING(COMMUNITY_NO)
       JOIN MEMBER USING(MEMBER_NO)
	  WHERE BOARD_STATUS = 'Y' AND
  	 	   COMMUNITY_NO != 1
   ORDER BY BOARD_NO DESC
  </select>
  
  <!-- 카테고리 게시글 조회 -->
  <select id="selectCategoryList" resultType="Community">
  	 SELECT BOARD_NO boardNo,
			BOARD_TITLE boardTitle,
			TO_CHAR(BOARD_DATE, 'YYYY-MM-DD') boardDate ,
			BOARD_VIEW_COUNT boardViewCount ,
			COMMUNITY_NAME communityName,
			NICKNAME userName
	   FROM COMMUNITY
       JOIN COMMUNITY_CATEGORY USING(COMMUNITY_NO)
       JOIN MEMBER USING(MEMBER_NO)
	  WHERE BOARD_STATUS = 'Y' AND
	  		COMMUNITY_NAME = #{category}
   ORDER BY BOARD_NO DESC
  </select>
  
  <!-- 공지 게시글 조회 -->
  <select id="selectNoticeList" resultType="Community">
  	 SELECT BOARD_NO boardNo,
			BOARD_TITLE boardTitle,
			TO_CHAR(BOARD_DATE, 'YYYY-MM-DD') boardDate ,
			BOARD_VIEW_COUNT boardViewCount ,
			COMMUNITY_NAME communityName,
			NICKNAME userName
	   FROM COMMUNITY
       JOIN COMMUNITY_CATEGORY USING(COMMUNITY_NO)
       JOIN MEMBER USING(MEMBER_NO)
	  WHERE BOARD_STATUS = 'Y' AND
	  		COMMUNITY_NAME = '공지'
   ORDER BY BOARD_NO DESC
  </select>
  
  <!-- 검색 게시글  개수 -->
  <select id="selectSearchCount" resultType="_int">
  	SELECT COUNT(*)
  	  FROM COMMUNITY
  	  JOIN MEMBER 
  	  	   USING (MEMBER_NO)
  	  JOIN COMMUNITY_CATEGORY 
  	  	   USING (COMMUNITY_NO)
  	 WHERE BOARD_STATUS = 'Y'
  	 <if test="condition == 'writer'">
  		 AND NICKNAME
	 </if>
	 <if test="condition == 'title'">
	 	AND BOARD_TITLE
	 </if>
	 <!--  
	 <if test="condition == 'content'">
	 	AND BOARD_CONTENT
	 </if>
	 -->
	 LIKE '%' || #{keyword} || '%'
	 <if test="category != '전체'"> <!-- 카테고리가 '전체'일 경우 커뮤니티 where 실행안함 -->
	 	 AND COMMUNITY_NAME 
	 	LIKE '%' || #{category} || '%'
	 </if>
	 
	</select>
	 
	<!-- 검색 게시글 목록 -->
  <select id="selectSearchList" resultType="Community">
  	 SELECT BOARD_NO boardNo,
			BOARD_TITLE boardTitle,
			TO_CHAR(BOARD_DATE, 'YYYY-MM-DD') boardDate ,
			BOARD_VIEW_COUNT boardViewCount ,
			COMMUNITY_NAME communityName,
			NICKNAME userName
	   FROM COMMUNITY
       JOIN COMMUNITY_CATEGORY USING(COMMUNITY_NO)
       JOIN MEMBER USING(MEMBER_NO)
       WHERE BOARD_STATUS = 'Y'
       	<if test="condition == 'writer'">
       		AND NICKNAME
		</if>
		<if test="condition == 'title'">
			AND BOARD_TITLE
		</if>
		<!--  
		<if test="condition == 'content'">
		 AND BOARD_CONTENT
		</if>
		-->
		 	LIKE '%' || #{keyword} || '%'
		 <if test="category != '전체'">
		 	AND COMMUNITY_NAME 
	 	 	LIKE '%' || #{category} || '%'
	 	 </if>
  		 	ORDER BY BOARD_NO DESC
  </select>
 
  	
  	<!-- 게시글 상세 -->
  	<select id="selectBoard" resultMap="boardResultSet">
  	 SELECT BOARD_NO,
			BOARD_TITLE,
			TO_CHAR(BOARD_DATE, 'YYYY-MM-DD') as BOARD_DATE,
			SEQ_BOARD_VIEW_COUNT.nextval,
			BOARD_STATUS,
			COMMUNITY_NO,
			MEMBER_NO,
			BOARD_CONTENT,
			NICKNAME
	   FROM COMMUNITY
	   JOIN MEMBER USING(MEMBER_NO)
	  WHERE BOARD_STATUS = 'Y'
	  	AND	BOARD_NO = #{boardNo}
  </select>
  
  <update id="deleteboard">
  	 UPDATE COMMUNITY
  	 	SET BOARD_STATUS = 'N'
	  WHERE BOARD_NO = #{boardNo}
  </update>
  
  <!-- 신고당한 게시글의 userNo찾기 -->
  	<select id="selectReportedUserNo" resultType="_int">
  		SELECT MEMBER_NO
  		  FROM COMMUNITY
  		WHERE USER_NO = #{boardNo}
  	</select>
  
  
  <!-- 신고기능 -->
  <insert id="insertReport">
  	INSERT INTO REPORT(
		  		REPORT_NO,
				TYPE_NO,
				DETAIL_CONTENT,
				MEMBER_NO,
				REPORTED_MEMBER_NO,
				REPLY_NO,
				BOARD_NO,
				REVIEW_NO
				) 
				VALUES (
				SEQ_REPORT_NO.nextval,
				#{TypeNo},
				#{detailContent},
				
				
				
		  	)
  </insert>

</mapper>





